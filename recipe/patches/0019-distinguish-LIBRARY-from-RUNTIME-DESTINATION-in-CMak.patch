From f76e80dbc06a4366fbe9c738e15764993a6fe383 Mon Sep 17 00:00:00 2001
From: "H. Vetinari" <h.vetinari@gmx.com>
Date: Tue, 28 Jan 2025 10:58:29 +1100
Subject: [PATCH 19/19] distinguish LIBRARY from RUNTIME DESTINATION in CMake
 install directives

Suggested-By: Silvio Traversaro <silvio@traversaro.it>
---
 c10/CMakeLists.txt                      |  8 +++--
 c10/cuda/CMakeLists.txt                 |  8 +++--
 c10/hip/CMakeLists.txt                  |  4 ++-
 c10/xpu/CMakeLists.txt                  |  8 +++--
 caffe2/CMakeLists.txt                   | 48 ++++++++++++++++++-------
 torch/CMakeLists.txt                    |  4 ++-
 torch/lib/libshm_windows/CMakeLists.txt |  8 +++--
 7 files changed, 66 insertions(+), 22 deletions(-)

diff --git a/c10/CMakeLists.txt b/c10/CMakeLists.txt
index 80e172497d5..933e8943b5c 100644
--- a/c10/CMakeLists.txt
+++ b/c10/CMakeLists.txt
@@ -162,7 +162,9 @@ if(NOT BUILD_LIBTORCHLESS)
   # Note: for now, we will put all export path into one single Caffe2Targets group
   # to deal with the cmake deployment need. Inside the Caffe2Targets set, the
   # individual libraries like libc10.so and libcaffe2.so are still self-contained.
-  install(TARGETS c10 EXPORT Caffe2Targets DESTINATION lib)
+  install(TARGETS c10 EXPORT Caffe2Targets
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin)
 endif()
 
 install(DIRECTORY ${CMAKE_CURRENT_LIST_DIR}
@@ -172,5 +174,7 @@ install(FILES ${CMAKE_BINARY_DIR}/c10/macros/cmake_macros.h
         DESTINATION include/c10/macros)
 
 if(MSVC AND C10_BUILD_SHARED_LIBS)
-  install(FILES $<TARGET_PDB_FILE:c10> DESTINATION lib OPTIONAL)
+  install(FILES $<TARGET_PDB_FILE:c10>
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin OPTIONAL)
 endif()
diff --git a/c10/cuda/CMakeLists.txt b/c10/cuda/CMakeLists.txt
index 3327dab4779..b8604169c54 100644
--- a/c10/cuda/CMakeLists.txt
+++ b/c10/cuda/CMakeLists.txt
@@ -82,7 +82,9 @@ if(NOT BUILD_LIBTORCHLESS)
 # Note: for now, we will put all export path into one single Caffe2Targets group
 # to deal with the cmake deployment need. Inside the Caffe2Targets set, the
 # individual libraries like libc10.so and libcaffe2.so are still self-contained.
-install(TARGETS c10_cuda EXPORT Caffe2Targets DESTINATION lib)
+install(TARGETS c10_cuda EXPORT Caffe2Targets
+        LIBRARY DESTINATION lib
+        RUNTIME DESTINATION bin)
 
 endif()
 
@@ -96,5 +98,7 @@ install(FILES ${CMAKE_BINARY_DIR}/c10/cuda/impl/cuda_cmake_macros.h
   DESTINATION include/c10/cuda/impl)
 
 if(MSVC AND C10_CUDA_BUILD_SHARED_LIBS)
-  install(FILES $<TARGET_PDB_FILE:c10_cuda> DESTINATION lib OPTIONAL)
+  install(FILES $<TARGET_PDB_FILE:c10_cuda>
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin OPTIONAL)
 endif()
diff --git a/c10/hip/CMakeLists.txt b/c10/hip/CMakeLists.txt
index f153030e793..de9837f238a 100644
--- a/c10/hip/CMakeLists.txt
+++ b/c10/hip/CMakeLists.txt
@@ -55,7 +55,9 @@ if(NOT BUILD_LIBTORCHLESS)
       $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../..>
       $<BUILD_INTERFACE:${CMAKE_BINARY_DIR}>
       $<INSTALL_INTERFACE:include>)
-  install(TARGETS c10_hip EXPORT Caffe2Targets DESTINATION lib)
+  install(TARGETS c10_hip EXPORT Caffe2Targets
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin)
   set(C10_HIP_LIB c10_hip)
 endif()
 
diff --git a/c10/xpu/CMakeLists.txt b/c10/xpu/CMakeLists.txt
index 01f77d61713..990c2aa7706 100644
--- a/c10/xpu/CMakeLists.txt
+++ b/c10/xpu/CMakeLists.txt
@@ -45,7 +45,9 @@ if(NOT BUILD_LIBTORCHLESS)
       $<BUILD_INTERFACE:${CMAKE_BINARY_DIR}>
       $<INSTALL_INTERFACE:include>
       )
-  install(TARGETS c10_xpu EXPORT Caffe2Targets DESTINATION lib)
+  install(TARGETS c10_xpu EXPORT Caffe2Targets
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin)
   set(C10_XPU_LIB c10_xpu)
   add_subdirectory(test)
 endif()
@@ -60,5 +62,7 @@ install(FILES ${CMAKE_BINARY_DIR}/c10/xpu/impl/xpu_cmake_macros.h
   DESTINATION include/c10/xpu/impl)
 
 if(MSVC AND C10_XPU_BUILD_SHARED_LIBS)
-  install(FILES $<TARGET_PDB_FILE:c10_xpu> DESTINATION lib OPTIONAL)
+  install(FILES $<TARGET_PDB_FILE:c10_xpu>
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin OPTIONAL)
 endif()
diff --git a/caffe2/CMakeLists.txt b/caffe2/CMakeLists.txt
index 9be7f3732f3..7397d4d7c9e 100644
--- a/caffe2/CMakeLists.txt
+++ b/caffe2/CMakeLists.txt
@@ -549,7 +549,9 @@ if(USE_CUDA)
   endif()
 
   target_link_libraries(caffe2_nvrtc PRIVATE caffe2::nvrtc ${DELAY_LOAD_FLAGS})
-  install(TARGETS caffe2_nvrtc DESTINATION "${TORCH_INSTALL_LIB_DIR}")
+  install(TARGETS caffe2_nvrtc
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin)
   if(USE_NCCL)
     list(APPEND Caffe2_GPU_SRCS
       ${TORCH_SRC_DIR}/csrc/cuda/nccl.cpp)
@@ -609,7 +611,9 @@ if(USE_ROCM)
   target_link_libraries(caffe2_nvrtc ${PYTORCH_HIP_LIBRARIES} ${ROCM_HIPRTC_LIB})
   target_include_directories(caffe2_nvrtc PRIVATE ${CMAKE_BINARY_DIR})
   target_compile_definitions(caffe2_nvrtc PRIVATE USE_ROCM __HIP_PLATFORM_AMD__)
-  install(TARGETS caffe2_nvrtc DESTINATION "${TORCH_INSTALL_LIB_DIR}")
+  install(TARGETS caffe2_nvrtc
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin)
 endif()
 
 if(NOT NO_API AND NOT BUILD_LITE_INTERPRETER)
@@ -995,7 +999,9 @@ elseif(USE_CUDA)
           CUDA::culibos ${CMAKE_DL_LIBS})
     endif()
     set_source_files_properties(${CMAKE_CURRENT_SOURCE_DIR}/../aten/src/ATen/native/cuda/LinearAlgebraStubs.cpp PROPERTIES COMPILE_FLAGS "-DBUILD_LAZY_CUDA_LINALG")
-    install(TARGETS torch_cuda_linalg DESTINATION "${TORCH_INSTALL_LIB_DIR}")
+    install(TARGETS torch_cuda_linalg
+            LIBRARY DESTINATION lib
+            RUNTIME DESTINATION bin)
   endif()
 
   if(USE_PRECOMPILED_HEADERS)
@@ -1467,17 +1473,27 @@ endif()
 
 caffe2_interface_library(torch torch_library)
 
-install(TARGETS torch_cpu torch_cpu_library EXPORT Caffe2Targets DESTINATION "${TORCH_INSTALL_LIB_DIR}")
+install(TARGETS torch_cpu torch_cpu_library EXPORT Caffe2Targets
+        LIBRARY DESTINATION lib
+        RUNTIME DESTINATION bin)
 
 if(USE_CUDA)
-  install(TARGETS torch_cuda torch_cuda_library EXPORT Caffe2Targets DESTINATION "${TORCH_INSTALL_LIB_DIR}")
+  install(TARGETS torch_cuda torch_cuda_library EXPORT Caffe2Targets
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin)
 elseif(USE_ROCM)
-  install(TARGETS torch_hip torch_hip_library EXPORT Caffe2Targets DESTINATION "${TORCH_INSTALL_LIB_DIR}")
+  install(TARGETS torch_hip torch_hip_library EXPORT Caffe2Targets
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin)
 elseif(USE_XPU)
-  install(TARGETS torch_xpu torch_xpu_library EXPORT Caffe2Targets DESTINATION "${TORCH_INSTALL_LIB_DIR}")
+  install(TARGETS torch_xpu torch_xpu_library EXPORT Caffe2Targets
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin)
 endif()
 
-install(TARGETS torch torch_library EXPORT Caffe2Targets DESTINATION "${TORCH_INSTALL_LIB_DIR}")
+install(TARGETS torch torch_library EXPORT Caffe2Targets
+        LIBRARY DESTINATION lib
+        RUNTIME DESTINATION bin)
 
 target_link_libraries(torch PUBLIC torch_cpu_library)
 
@@ -1498,11 +1514,17 @@ endif()
 
 # Install PDB files for MSVC builds
 if(MSVC AND BUILD_SHARED_LIBS)
-  install(FILES $<TARGET_PDB_FILE:torch_cpu> DESTINATION "${TORCH_INSTALL_LIB_DIR}" OPTIONAL)
+  install(FILES $<TARGET_PDB_FILE:torch_cpu> DESTINATION
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin OPTIONAL)
   if(USE_CUDA)
-    install(FILES $<TARGET_PDB_FILE:torch_cuda> DESTINATION "${TORCH_INSTALL_LIB_DIR}" OPTIONAL)
+    install(FILES $<TARGET_PDB_FILE:torch_cuda> DESTINATION
+            LIBRARY DESTINATION lib
+            RUNTIME DESTINATION bin OPTIONAL)
   elseif(USE_ROCM)
-    install(FILES $<TARGET_PDB_FILE:torch_hip> DESTINATION "${TORCH_INSTALL_LIB_DIR}" OPTIONAL)
+    install(FILES $<TARGET_PDB_FILE:torch_hip> DESTINATION
+            LIBRARY DESTINATION lib
+            RUNTIME DESTINATION bin OPTIONAL)
   endif()
 endif()
 
@@ -1616,7 +1638,9 @@ if(BUILD_SHARED_LIBS)
       target_link_libraries(torch_global_deps torch::nvtoolsext)
     endif()
   endif()
-  install(TARGETS torch_global_deps DESTINATION "${TORCH_INSTALL_LIB_DIR}")
+  install(TARGETS torch_global_deps
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin)
 endif()
 
 # ---[ Caffe2 HIP sources.
diff --git a/torch/CMakeLists.txt b/torch/CMakeLists.txt
index c74b45431c9..2916b82b7fb 100644
--- a/torch/CMakeLists.txt
+++ b/torch/CMakeLists.txt
@@ -447,7 +447,9 @@ if(NOT TORCH_PYTHON_LINK_FLAGS STREQUAL "")
     set_target_properties(torch_python PROPERTIES LINK_FLAGS ${TORCH_PYTHON_LINK_FLAGS})
 endif()
 
-install(TARGETS torch_python DESTINATION "${TORCH_INSTALL_LIB_DIR}")
+install(TARGETS torch_python
+        LIBRARY DESTINATION lib
+        RUNTIME DESTINATION bin)
 
 # Generate torch/version.py from the appropriate CMake cache variables.
 if(${CMAKE_BUILD_TYPE} STREQUAL "Debug")
diff --git a/torch/lib/libshm_windows/CMakeLists.txt b/torch/lib/libshm_windows/CMakeLists.txt
index df2a1064938..96c494d544b 100644
--- a/torch/lib/libshm_windows/CMakeLists.txt
+++ b/torch/lib/libshm_windows/CMakeLists.txt
@@ -19,9 +19,13 @@ target_include_directories(shm PRIVATE
 target_link_libraries(shm torch c10)
 
 
-install(TARGETS shm DESTINATION "${LIBSHM_INSTALL_LIB_SUBDIR}")
+install(TARGETS shm
+        LIBRARY DESTINATION lib
+        RUNTIME DESTINATION bin)
 install(FILES libshm.h DESTINATION "include")
 
 if(MSVC AND BUILD_SHARED_LIBS)
-  install(FILES $<TARGET_PDB_FILE:shm> DESTINATION "${LIBSHM_INSTALL_LIB_SUBDIR}" OPTIONAL)
+  install(FILES $<TARGET_PDB_FILE:shm>
+          LIBRARY DESTINATION lib
+          RUNTIME DESTINATION bin OPTIONAL)
 endif()
